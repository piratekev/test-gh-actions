name: Manually triggered workflow
on:
  push:
    branches:
      - 'release-*'
    tags:
      - '*'


jobs:
  check:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            
        - name: Get current branch
          id: check_step
          run: |
            raw=$(git branch -r --contains ${{ github.ref }})
            branch=${raw##*/}
            echo "::set-output name=branch::$branch"
            echo "Branch is $branch."
            
        - name: Get version from branch
          id: branch_version_step
          run: |
            branch_version=$(echo ${{ steps.check_step.outputs.branch }} | cut -d- -f2)
            echo "::set-output name=branch_version::$branch_version"
            echo "branch_version is $branch_version."
            
        - name: Get version from tag
          id: tag_version_step
          if: ${{ github.ref_type == 'tag' }}
          run: |
            tag_version_hotfix=$(echo ${{ github.ref_name }} | cut -dv -f2)
            tag_version=$(echo $tag_version_hotfix | cut -d_ -f1)
            hotfix_version=$(echo $tag_version_hotfix | cut -d_ -f2)
            prev_hotfix_version=$(($hotfix_version - 1))
            prev_tag_version="v$tag_version"
            prev_tag_version+="_$prev_hotfix_version"
            echo "tag_version is $tag_version."
            echo "hotfix_version is $hotfix_version."
            echo "prev_tag_version is $prev_tag_version."
            echo "::set-output name=hotfix_version::$hotfix_version"
            echo "::set-output name=tag_version::$tag_version"
            echo "::set-output name=prev_tag_version::$prev_tag_version"
            
            
        # Check for previous hotfix version
        - name: Search for previous hotfix version
          if: ${{ steps.tag_version_step.outputs.hotfix_version != 1 }}
          uses: mukunku/tag-exists-action@v1.0.0
          id: checkTag
          with: 
            tag: ${{ steps.tag_version_step.outputs.prev_tag_version }}
          env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Verify previous hotfix tag exists
          if: ${{ steps.tag_version_step.outputs.hotfix_version != 1 && !steps.checkTag.outputs.exists }} 
          run: |
            exit 1

  log-github-info:
    runs-on: ubuntu-latest
    needs: check
    steps:
      - run: echo fuck
